---
title: "Tributary Nitrogen Concentrations and Rainfall"
author: "Curtis C. Bohlen, Casco Bay Estuary Partnership."
date: "04/22/2021"
output:
  github_document:
    toc: true
    fig_width: 5
    fig_height: 4
---

<img
    src="https://www.cascobayestuary.org/wp-content/uploads/2014/04/logo_sm.jpg"
    style="position:absolute;top:10px;right:50px;" />

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = 'center',
                      fig.width = 5, fig.height = 4,
                      collapse = TRUE, comment = "#>")
```

# Install Libraries
```{r}
library(readxl)
library(readr)
library(tidyverse)
library(GGally)

library(CBEPgraphics)
load_cbep_fonts()
theme_set(theme_cbep())
```

# Read Data
```{r foder_refs}
sibfldnm <- 'Original_Data'
parent <- dirname(getwd())
sibling <- paste(parent,sibfldnm, sep = '/')
fn <- '2017-18 Casco Bay Tributary Nitrogen Concentrations.xlsx'

dir.create(file.path(getwd(), 'figures'), showWarnings = FALSE)
```


```{r warning = FALSE}
the_data <- read_excel(file.path(sibling, fn), 
                       col_types = c("date", "numeric", "numeric", 
                                     "numeric", "numeric"), skip = 1) %>%
  filter( ! is.na(Date)) %>%
  rename(dt = Date,
         tn = `TN (mg/l)`,
         nox = `NOx (mg/L)`,
         nh4 = `NH4 (mg/L)`,
         organic = `Organic (mg/L)`) %>%
  mutate(dt = as.Date(dt))
```


```{r}
the_data$tributary <- c(rep('Presumpscot',17), 
                        rep('Royal', 19), 
                        rep('Capisic', 16))
the_data <- the_data %>%
  relocate(tributary) %>%
  mutate(tributary = factor(tributary, levels = c('Capisic', 'Royal', 'Presumpscot')))
```

# Rainfall Data
Downloaded rainfall data is in tenths of millimeters.
```{r warning = FALSE}
rain_data <- read_csv(file.path(sibling, 'portland_weather5_17-8_18.csv'),
                      col_types = cols(
                        .default = col_skip(),
                        date = col_date(format = ""),
                        PRCP = col_double())) %>%
  mutate(PRCP = PRCP / 10)
```

## Add Lagged terms
```{r}
rain_data <- rain_data %>% mutate(LagOne   = lag(PRCP),
                             SumThree = reduce(map(1:3, ~lag(PRCP, ., 0)), `+`),
                             SumFive  = reduce(map(1:5, ~lag(PRCP, ., 0)), `+`))
```

## Merge Data Together
Lagged functions generate either nonsense or NAs, but only for the first few 
days of the rain_data.  Here we don't call on any of those days, so we can use 
the data "as is" without worrying.

Notice the use of "match" here to gather exact date matches. This allows 
something very much like a lookup table.
```{r}
the_data <- the_data %>% 
  mutate(DayOf = rain_data$PRCP[match(the_data$dt, rain_data$date)],
         LagOne = rain_data$LagOne[match(the_data$dt, rain_data$date)],
         SumThree =  rain_data$SumThree[match(the_data$dt, rain_data$date)],
         SumFive = rain_data$SumFive[match(the_data$dt, rain_data$date)])
rm(rain_data)
```


# Correlation Between Rivers by Date 
```{r}
tmp <- the_data %>% select(dt, tributary, tn) %>%
  spread(tributary, tn) %>% select(-1)
  cor(tmp, use = "p")
  cor(tmp, use = "p", method = 's')
```

```{r}
plt <- ggpairs(tmp)
plt

```
So, the apparent correlations across sites are pretty wobbly....

```{r}
plt <- ggplot(the_data, aes(dt, tn, color = tributary)) +
  geom_line()  +
  geom_point(size = 2) +
  scale_color_manual(values=cbep_colors(), name = '') +
  scale_x_date(date_breaks = '3 month', date_labels = '%m/%Y', name = '') +
  theme(legend.position = 'bottom',
        axis.text.x = element_text(size = 11)) +
  ylab('Total Nitrogen (mg/l)')
plt
```



## Examine Rainfall Correlations
```{r}
tmp <- the_data %>% 
  select(dt, tributary, tn, DayOf, LagOne, SumThree, SumFive) %>%
  pivot_wider(names_from = tributary, values_from = tn) %>%
  select(-dt)
  cor(tmp, use = "p")
```

### And rank correlations
```{r}
  cor(tmp, use = "p", method = "s")
  cor(tmp, use = "p", method = "k")
```

Sample sizes are pretty small, so I would not lean heavily on this, but it looks
like:    
1.  Concentrations are largely independent of rainfall on the sample day,
    perhaps because much of that rainfall may have fallen after the sample was
    drawn.  At least, correlation coefficients are low enough that I would not
    want to push the idea on these data alone.  
2.  I see few correlations with the one day lag.  
3.  The Presumpscot shows positive correlations with precipitation, lag one,
    and the  three day and five day sums.

# Plot the TN Data By Recent Rainfall
```{r}
plt <- ggplot(the_data, aes(SumFive, tn, color = tributary)) + 
  geom_point( ) + 
  geom_smooth(method = 'lm', aes(fill = tributary)) +
  scale_y_log10() +
  ylab("Total Nitrogen (mg/l)") + 
  xlab("Portland Rainfall\nPrevious Five Days (mm)") +
  scale_color_manual(values = cbep_colors(), name = '') +
  scale_fill_manual(values = cbep_colors(), name = '') +  
  scale_x_continuous(trans = 'log1p', breaks = c(0,1, 5, 10, 50)) +
  theme_cbep(base_size = 14) +
  theme(legend.position = 'bottom')
plt

```

So, what this shows us is that when there's little or no rainfall over the prior
few day, we'd expect very low N concentrations on the Presumscot, but that
concentration climbs after rain.  Give the limited number of samples, though, we
can't really tell what shape the relationship with rainfall may be.  From these 
data, there is a weak suggestion of elevated nitrogen concentrations only for 
the highest recent rainfal lvalues.


